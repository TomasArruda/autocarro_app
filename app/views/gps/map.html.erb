<!doctype html>

<html>

<head>
    <script src="cytoscape.js"></script>
</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }
</style>
<body>

  <div id="buses_position", style="display: none;" value=<%= @buses_position.to_json %>></div>

    <div id="cy"></div>
    
    <script>
    
      var bus_map = JSON.parse(document.getElementById('buses_position').getAttribute('value'));

      function mountElements(bus_map){
        var elements = [];
        var bus_stops = bus_map.bus_stops;

        elements = elements.concat(mountBusStops(bus_map))
        elements = elements.concat(mountBuses(bus_map))
        elements = elements.concat(mountConnections(bus_map))
        
        return elements;
      };

      function mountBusStops(bus_map){
        var elements = [];
        var bus_stops = bus_map.bus_stops;

        for(var i = 0; i < bus_stops.length; i++){
          elements.push(
            { data: { id: bus_stops[i], classes: 'bus-stop' } }
          );
        }
        
        return elements;
      };

      function mountBuses(bus_map){
        var elements = [];
        var buses = bus_map.buses;

        for(var i = 0; i < buses.length; i++){
          elements.push(
            { data: { id: "bus "+i, classes: 'bus' } }
          );
        }

        return elements;
      };

      function mountConnections(bus_map){
        var elements = [];
        var connections = bus_map.connections;

        for(var i = 0; i < connections.length; i++){
          var start = connections[i].start;
          var next = connections[i].next;
          elements.push(
            { data: { id: start+next, source: start, target: next, classes: 'connection' } }
          );
        }

        return elements;
      };

      var elements = mountElements(bus_map);
      console.log(elements);

      var cy = cytoscape({
        container: document.getElementById('cy'),
          elements: elements,
          style: [ 
            {
              selector: '.pa',
              style: {
                'background-color': '#666',
                'label': 'data(id)'
              }
            },

            {
              selector: '.bob',
              style: {
                'background-color': 'red',
                'label': 'data(id)'
              }
            },

            {
              selector: 'edge',
              style: {
                'width': 3,
                'line-color': '#ccc',
                'target-arrow-color': '#ccc',
                'target-arrow-shape': 'triangle'
              }
            }
          ],
          layout: {
            name: 'grid',
            rows: 1
          }     
      });
    </script>
</body>
</html>